// Prisma Schema for Restaurant Management System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  MANAGER
  WAITER
  CHEF
  CUSTOMER
}

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  MAINTENANCE
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ShiftStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Models

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  phone         String?
  profileImage  String?  @map("profile_image")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  orders        Order[]
  reservations  Reservation[]
  reviews       Review[]
  loyaltyPoints LoyaltyPoints?
  notifications Notification[]
  staffShifts   StaffShift[]

  @@map("users")
}

model Category {
  id           String    @id @default(uuid())
  name         String
  description  String?
  displayOrder Int       @default(0) @map("display_order")
  icon         String?
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  menuItems    MenuItem[]

  @@map("categories")
}

model MenuItem {
  id              String   @id @default(uuid())
  name            String
  description     String?
  categoryId      String?  @map("category_id")
  price           Decimal  @db.Decimal(10, 2)
  preparationTime Int      @default(15) @map("preparation_time") // in minutes
  imageUrl        String?  @map("image_url")
  isAvailable     Boolean  @default(true) @map("is_available")
  isFeatured      Boolean  @default(false) @map("is_featured")
  calories        Int?
  allergens       String[] // Array of allergen strings
  dietaryTags     String[] @map("dietary_tags") // vegetarian, vegan, gluten-free, etc.
  spiceLevel      Int?     @map("spice_level") // 0-5
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  category        Category?   @relation(fields: [categoryId], references: [id])
  orderItems      OrderItem[]

  @@map("menu_items")
}

model Table {
  id           String      @id @default(uuid())
  tableNumber  String      @unique @map("table_number")
  capacity     Int
  status       TableStatus @default(AVAILABLE)
  qrCodeUrl    String?     @map("qr_code_url")
  floorSection String?     @map("floor_section")
  positionX    Decimal?    @map("position_x") @db.Decimal(10, 2)
  positionY    Decimal?    @map("position_y") @db.Decimal(10, 2)
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  orders       Order[]
  reservations Reservation[]

  @@map("tables")
}

model Order {
  id                   String        @id @default(uuid())
  orderNumber          String        @unique @map("order_number")
  customerId           String?       @map("customer_id")
  tableId              String?       @map("table_id")
  orderType            OrderType     @map("order_type")
  status               OrderStatus   @default(PENDING)
  subtotal             Decimal       @db.Decimal(10, 2)
  tax                  Decimal       @default(0) @db.Decimal(10, 2)
  discount             Decimal       @default(0) @db.Decimal(10, 2)
  tip                  Decimal       @default(0) @db.Decimal(10, 2)
  total                Decimal       @db.Decimal(10, 2)
  paymentMethod        String?       @map("payment_method")
  paymentStatus        PaymentStatus @default(PENDING) @map("payment_status")
  specialInstructions  String?       @map("special_instructions")
  deliveryAddress      String?       @map("delivery_address")
  customerName         String?       @map("customer_name")
  customerPhone        String?       @map("customer_phone")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  completedAt          DateTime?     @map("completed_at")

  // Relations
  customer     User?         @relation(fields: [customerId], references: [id])
  table        Table?        @relation(fields: [tableId], references: [id])
  orderItems   OrderItem[]
  transactions Transaction[]
  reviews      Review[]

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model KitchenStation {
  id          String    @id @default(uuid())
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")

  // Relations
  orderItems  OrderItem[]

  @@map("kitchen_stations")
}

model OrderItem {
  id                   String          @id @default(uuid())
  orderId              String          @map("order_id")
  menuItemId           String?         @map("menu_item_id")
  stationId            String?         @map("station_id")
  quantity             Int
  unitPrice            Decimal         @db.Decimal(10, 2) @map("unit_price")
  customizations       Json?           // JSON object for customizations
  specialInstructions  String?         @map("special_instructions")
  status               OrderItemStatus @default(PENDING)
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  // Relations
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem    MenuItem?       @relation(fields: [menuItemId], references: [id])
  station     KitchenStation? @relation(fields: [stationId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model Reservation {
  id               String            @id @default(uuid())
  customerId       String?           @map("customer_id")
  tableId          String?           @map("table_id")
  reservationDate  DateTime          @map("reservation_date") @db.Date
  reservationTime  DateTime          @map("reservation_time") @db.Time
  partySize        Int               @map("party_size")
  status           ReservationStatus @default(PENDING)
  specialRequests  String?           @map("special_requests")
  customerName     String            @map("customer_name")
  customerPhone    String            @map("customer_phone")
  customerEmail    String?           @map("customer_email")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  // Relations
  customer User?  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  table    Table? @relation(fields: [tableId], references: [id])

  @@index([reservationDate, reservationTime])
  @@map("reservations")
}

model Supplier {
  id            String    @id @default(uuid())
  name          String
  contactPerson String?   @map("contact_person")
  phone         String?
  email         String?
  address       String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  inventory Inventory[]

  @@map("suppliers")
}

model Inventory {
  id             String    @id @default(uuid())
  ingredientName String    @map("ingredient_name")
  quantity       Decimal   @db.Decimal(10, 2)
  unit           String    // kg, liters, pieces, etc.
  minimumStock   Decimal   @default(0) @map("minimum_stock") @db.Decimal(10, 2)
  costPerUnit    Decimal?  @map("cost_per_unit") @db.Decimal(10, 2)
  supplierId     String?   @map("supplier_id")
  lastRestocked  DateTime? @map("last_restocked")
  expiryDate     DateTime? @map("expiry_date") @db.Date
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@map("inventory")
}

model Transaction {
  id            String            @id @default(uuid())
  orderId       String            @map("order_id")
  amount        Decimal           @db.Decimal(10, 2)
  paymentMethod String            @map("payment_method")
  transactionId String?           @map("transaction_id") // from payment gateway
  status        TransactionStatus @default(PENDING)
  metadata      Json?             // Additional payment gateway data
  createdAt     DateTime          @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("transactions")
}

model LoyaltyPoints {
  id             String   @id @default(uuid())
  customerId     String   @unique @map("customer_id")
  points         Int      @default(0)
  totalEarned    Int      @default(0) @map("total_earned")
  totalRedeemed  Int      @default(0) @map("total_redeemed")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  customer User @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("loyalty_points")
}

model Review {
  id            String   @id @default(uuid())
  orderId       String   @map("order_id")
  customerId    String   @map("customer_id")
  rating        Int      // 1-5
  comment       String?
  foodRating    Int?     @map("food_rating") // 1-5
  serviceRating Int?     @map("service_rating") // 1-5
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  order    Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  customer User  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@map("reviews")
}

model StaffShift {
  id        String      @id @default(uuid())
  staffId   String      @map("staff_id")
  shiftDate DateTime    @map("shift_date") @db.Date
  startTime DateTime    @map("start_time") @db.Time
  endTime   DateTime    @map("end_time") @db.Time
  status    ShiftStatus @default(SCHEDULED)
  notes     String?
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  staff User @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("staff_shifts")
}

model PromoCode {
  id               String    @id @default(uuid())
  code             String    @unique
  description      String?
  discountType     String    @map("discount_type") // percentage, fixed
  discountValue    Decimal   @map("discount_value") @db.Decimal(10, 2)
  minOrderAmount   Decimal   @default(0) @map("min_order_amount") @db.Decimal(10, 2)
  maxDiscount      Decimal?  @map("max_discount") @db.Decimal(10, 2)
  usageLimit       Int?      @map("usage_limit")
  usedCount        Int       @default(0) @map("used_count")
  validFrom        DateTime? @map("valid_from")
  validUntil       DateTime? @map("valid_until")
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")

  @@map("promo_codes")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  message   String
  type      String? // order_update, promotion, alert, etc.
  isRead    Boolean  @default(false) @map("is_read")
  metadata  Json? // Additional data
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
